import{d as e,au as a,ay as n,s as d,r as i,an as t,aH as s,o,Y as c,b2 as l,a5 as r,a2 as p,a4 as h,_ as u,I as y,b4 as f,bn as m,c as k,Z as v}from"./common.5a7f0626.js";import{u as x}from"./use-lifecycle.6693a5e5.js";import{m as g,g as _,a as b}from"./map.883aa095.js";import{_ as w,w as I}from"./read.03cd8dda.js";const O=["onDblclick"],K={key:0,class:"tree-slider"};var W=w(e({__name:"index",setup(e){const{activate:w,disable:W,currentWidget:Z}=I.exports.useWidget();a((()=>{$()})),n((()=>{W("layer-tree")})),x(g),Z.onUpdate((()=>{C.value=[],E.value=[],U.value=[],$()}));const C=d([]),E=d([]),U=d([]),j={},A=i({});let D;const P=(e,a)=>{var n,d,i;const t=j[a.node.id];if(t){if(t.isAdded||b(t),(null==(n=t.options)?void 0:n.radio)&&a.checked)for(const e in j){const a=j[e];U.value.forEach(((e,n)=>{a===j[e]&&t.pid===j[e].pid&&a!==t&&(U.value.splice(n,1),a.show=!1)}))}(null==(d=t.options)?void 0:d.onWidget)&&(a.checked?(D&&W(D),w({name:t.options.onWidget}),D=t.options.onWidget):W(t.options.onWidget)),a.node.children&&a.node.children.length&&T(e,a.node.children),-1!==e.indexOf(a.node.id)?(t.show=!0,t.readyPromise&&t.readyPromise.then((function(e){e.flyTo()}))):t.show=!1,(null==(i=t.options)?void 0:i.scenetree)&&M(t)}};function T(e,a){a.forEach((a=>{const n=j[a.id];n&&(n.isAdded||b(n),-1!==e.indexOf(a.id)?n.show=!0:n.show=!1,a.children&&T(e,a.children),n.options.scenetree&&M(n))}))}function $(){const e=_();for(let a=e.length-1;a>=0;a--){const n=e[a];if(n._hasMapInit||-1!==n.pid||99===n.id||(n.pid=99),j[n.id]=n,n&&-1===n.pid){const d=i({index:a,title:n.name||`未命名(${n.type})`,key:n.id,id:n.id,pId:n.pid,hasZIndex:n.hasZIndex,hasOpacity:n.hasOpacity,opacity:100*(n.opacity||0)});n.hasOpacity&&(A[n.id]=100*(n.opacity||0)),d.children=H(d,e),C.value.push(d),!1!==n.options.open&&E.value.push(d.key),n.isAdded&&n.show&&t((()=>{U.value.push(d.key)}))}}C.value.forEach((e=>{e.children.forEach((e=>{e.children&&e.children.forEach((e=>{j[e.key].options.radio&&(e.parent.disabled=!0)}))}))}))}function H(e,a){return a.filter((a=>a.pid===e.id)).reverse().map(((n,d)=>{const i={index:d,title:n.name||`未命名(${n.type})`,key:n.id,id:n.id,pId:n.pid,hasZIndex:n.hasZIndex,hasOpacity:n.hasOpacity,opacity:100*(n.opacity||0),parent:e};return n.hasOpacity&&(A[n.id]=100*(n.opacity||0)),j[n.id]=n,i.children=H(i,a),!1!==n.options.open&&E.value.push(i.key),n.isAdded&&n.show&&t((()=>{U.value.push(i.key)})),i}))}function M(e){W("layer-tree"),Y&&(Y.off("click",q),Y=null),e.options.scenetree&&(e.on("click",q),Y=e)}let Y;function q(e){const a=e.layer,n=a.options.url,d=a.id;w({name:"layer-tree",data:{url:n,id:d}})}return(e,a)=>{const n=s("a-menu-item"),d=s("a-menu"),i=s("mars-dropdown-menu"),t=s("mars-slider"),x=s("mars-tree"),g=s("mars-dialog");return o(),c(g,{draggable:!0,title:"图层",width:"312","min-width":250,top:"50",left:"50"},{default:l((()=>[r(x,{checkable:"","tree-data":C.value,expandedKeys:E.value,"onUpdate:expandedKeys":a[0]||(a[0]=e=>E.value=e),checkedKeys:U.value,"onUpdate:checkedKeys":a[1]||(a[1]=e=>U.value=e),onCheck:P},{title:l((e=>[r(i,{trigger:["contextmenu"]},p({default:l((()=>[u("span",{onDblclick:a=>{var n;(n=e).checked&&j[n.id].flyTo()}},y(e.title),41,O)])),_:2},[e.hasZIndex?{name:"overlay",fn:l((()=>[r(d,{onClick:a=>((e,a)=>{const n=e.parent,d=e.index;switch(a){case"1":0!==d&&(n.children[0].index=d,n.children[d].index=0);break;case"2":n.children[d-1].index=d,n.children[d].index=d-1;break;case"3":n.children[d+1].index=d,n.children[d].index=d+1;break;case"4":n.children[n.children.length-1].index=d,n.children[d].index=n.children.length-1}n.children=n.children.sort(((e,a)=>e.index-a.index))})(e,a.key)},{default:l((()=>[r(n,{key:"1"},{default:l((()=>[h("图层置为顶层")])),_:1}),r(n,{key:"2"},{default:l((()=>[h("图层上移一层")])),_:1}),r(n,{key:"3"},{default:l((()=>[h("图层下移一层")])),_:1}),r(n,{key:"4"},{default:l((()=>[h("图层置为底层")])),_:1})])),_:2},1032,["onClick"])])),key:"0"}:void 0]),1024),e.hasOpacity?f((o(),k("span",K,[r(t,{value:A[e.id],"onUpdate:value":a=>A[e.id]=a,min:0,step:1,max:100,onChange:a=>(e=>{const a=e.id,n=j[a];n&&(n.opacity=A[a]/100)})(e)},null,8,["value","onUpdate:value","onChange"])],512)),[[m,e.checked]]):v("",!0)])),_:1},8,["tree-data","expandedKeys","checkedKeys"])])),_:1})}}}),[["__scopeId","data-v-75de5fae"]]);export{W as default};
